{% extends "base.html" %}

{% block title %}Mevzuat{% endblock %}

{% block extra_css %}
<style>
  .legend-item { display: flex; align-items: center; margin-bottom: .25rem; }
  .legend-color { width: 12px; height: 12px; display: inline-block; margin-right: .5rem; border-radius: 2px; }
</style>
{% endblock %}

{% block content %}

<div class="row">
  <div class="col-lg-8">
    <canvas id="documentsChart" height="150"></canvas>
  </div>
  <div class="col-lg-4 d-flex flex-column h-100">
    <div id="chartLegend" class="small mb-3"></div>
    <div id="rangeButtons" class="btn-group w-100" role="group">
      <button type="button" class="btn btn-outline-secondary flex-fill active" data-range="30days">30 Days</button>
      <button type="button" class="btn btn-outline-secondary flex-fill" data-range="thisYear">This Year</button>
      <button type="button" class="btn btn-outline-secondary flex-fill" data-range="lastYear">Last Year</button>
      <button type="button" class="btn btn-outline-secondary flex-fill" data-range="all">All</button>
    </div>
  </div>
</div>

<hr class="my-5">

<div class="row">
  <div class="col-12">
    <h2 class="fs-4">Recently Added Documents</h2>
    <ul class="list-group">
      {% for doc in recent_documents %}
        <li class="list-group-item">
          <strong>
            {% if doc.original_document_url %}
              <a href="{{ doc.original_document_url }}" target="_blank">{{ doc.title }}</a>
            {% else %}
              {{ doc.title }}
            {% endif %}
          </strong><br>
          <small class="text-muted">
            {% if doc.date %}{{ doc.date }}{% endif %}
            {% if doc.type %}
              {% if doc.date %} | {% endif %}{{ doc.type.name }}
            {% endif %}
          </small>
        </li>
      {% empty %}
        <li class="list-group-item">No documents available.</li>
      {% endfor %}
    </ul>
  </div>
</div>

<hr class="my-5">

<div class="row">
  <div class="col-12">
    <h2 class="fs-4">API Access</h2>
    <p>You can access our data programmatically through the available API endpoints. Full interactive documentation is available at <a href="/api/docs">/api/docs</a>.</p>
    <ul>
      <li><code>GET /api/documents/types</code> — List all available document types.</li>
      <li><code>GET /api/documents/counts</code> — Get counts of documents by type over a time interval.</li>
      <li><code>GET /api/documents/list</code> — List documents with filters such as type, year, month, or date range.</li>
      <li><code>GET /api/documents/search</code> — Search documents with optional filters like type and date range.</li>
    </ul>
  </div>
</div>

<hr class="my-5">

<div class="row">
  <div class="col-12">
    <h2 class="fs-4">MCP Access</h2>
    <p>The same functionality is also available through <strong>Model Context Protocol (MCP)</strong> tools. This allows you to integrate document data directly into AI-powered workflows.</p>
    <p>The MCP server is available at: <code>https://mevzuat.info/mcp/</code></p>
    <ul>
      <li><code>types</code> — List all available document types.</li>
      <li><code>counts</code> — Get counts of documents by type over a time interval.</li>
      <li><code>list</code> — List documents with filters such as type, year, month, or date range.</li>
      <li><code>search</code> — Search documents with optional filters like type and date range.</li>
    </ul>
    <p>Refer to the <a href="/api/docs">API documentation</a> for detailed parameter descriptions, which also apply when using these tools via MCP.</p>
  </div>
</div>

<hr class="my-5">
<div class="row">
  <div class="col-12">
    <h2 class="fs-4">Source repository</h2>
    <p>
      You can find the source code and contribute via our
      <a href="https://github.com/onurmatik/mevzuat/" target="_blank">
        <i class="bi bi-github"></i> GitHub repository
      </a>.
    </p>
    <p>Although its primary focus is on Turkish legislation, it is built as a flexible Django project that can be adapted to similar document intelligence needs in other contexts.</p>
    <p>We invite you to use it, experiment with it, and contribute.</p>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const palette = ['#0d6efd','#6c757d','#198754','#dc3545','#ffc107','#0dcaf0','#6610f2','#d63384','#20c997','#fd7e14'];
    const rangeButtons = document.getElementById('rangeButtons');
    let currentRange = '30days';
    const legend = document.getElementById('chartLegend');
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    let chart;
    const typeMap = {}; // label -> {id, color}

    loadTypes();

    async function loadTypes() {
      try {
        const res = await fetch('/api/documents/types');
        const types = await res.json();
        types.forEach((t, idx) => {
          typeMap[t.label] = { id: t.id, color: palette[idx % palette.length] };
        });
        updateChart();
      } catch (err) {
        console.error(err);
      }
    }

    function getRange() {
      const opt = currentRange;
      const today = new Date();
      let start = '', end = '', interval = 'year';
      if (opt === 'thisYear') {
        start = `${today.getFullYear()}-01-01`;
        end = today.toISOString().split('T')[0];
        interval = 'month';
      } else if (opt === 'lastYear') {
        const year = today.getFullYear() - 1;
        start = `${year}-01-01`;
        end = `${year}-12-31`;
        interval = 'month';
      } else if (opt === '30days') {
        const past = new Date();
        past.setDate(today.getDate() - 30);
        start = past.toISOString().split('T')[0];
        end = today.toISOString().split('T')[0];
        interval = 'day';
      }
      return { start, end, interval };
    }

    async function fetchCounts() {
      const { start, end, interval } = getRange();
      const params = new URLSearchParams();
      params.set('interval', interval);
      if (start) params.set('start_date', start);
      if (end) params.set('end_date', end);
      const res = await fetch('/api/documents/counts?' + params.toString());
      return await res.json();
    }

    async function updateChart() {
      const rows = await fetchCounts();
      const labels = Object.keys(typeMap);
      const periods = Array.from(new Set(rows.map(r => r.period))).sort();
      const datasetMap = {};
      labels.forEach(l => datasetMap[l] = Array(periods.length).fill(0));
      rows.forEach(r => {
        const idx = periods.indexOf(r.period);
        if (idx !== -1 && datasetMap[r.type] !== undefined) {
          datasetMap[r.type][idx] = r.count;
        }
      });
      const datasets = labels.map(l => ({
        label: l,
        data: datasetMap[l],
        backgroundColor: typeMap[l].color,
        stack: 'docs'
      }));
      const ctx = document.getElementById('documentsChart');
      if (!chart) {
        chart = new Chart(ctx, {
          type: 'bar',
          data: { labels: periods, datasets },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
          }
        });
      } else {
        chart.data.labels = periods;
        chart.data.datasets = datasets;
        chart.update();
      }
      updateLegend(rows, periods);
    }

    function updateLegend(rows, periods) {
      if (!rows.length) {
        legend.innerHTML = '<p>No data</p>';
        return;
      }
      const totals = {};
      rows.forEach(r => {
        totals[r.type] = (totals[r.type] || 0) + r.count;
      });
      const first = periods[0];
      const last = periods[periods.length - 1];
      let html = `<div class="mb-2"><strong>Date Range:</strong> ${first} – ${last}</div>`;
      html += '<ul class="list-unstyled">';
      Object.keys(typeMap).forEach(label => {
        html += `<li class="legend-item"><span class="legend-color" style="background:${typeMap[label].color}"></span>${label}: ${totals[label] || 0}</li>`;
      });
      html += '</ul>';
      legend.innerHTML = html;
    }

      rangeButtons.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          rangeButtons.querySelectorAll('button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentRange = btn.getAttribute('data-range');
          updateChart();
        });
      });

    searchForm.addEventListener('submit', e => {
      e.preventDefault();
      const q = searchInput.value.trim();
      if (!q) return;
      const params = new URLSearchParams({ query: q });
      const { start, end } = getRange();
      if (start) params.set('start_date', start);
      if (end) params.set('end_date', end);
      window.location.href = '/search?' + params.toString();
    });
  });
</script>
{% endblock %}
